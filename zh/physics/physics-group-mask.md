# 分组和掩码

掩码（Mask）在计算机学科及数字逻辑中指的是一串二进制数字，通过与目标数字的 [按位操作](https://www.w3school.com.cn/js/js_bitwise.asp)，从而判断是否满足条件。

在 Cocos Creator 中，部分物理组件（目前有刚体组件和碰撞器组件）提供了设置分组和掩码的接口，方便开发者对物理组件分组，并决定哪些组件之间会进行检测。

## 共享

在 Cocos Creator 中，目前物理元素和节点是一对一的关系，分组和掩码是属于物理元素的，单个节点上的物理组件修改的都是节点对应物理元素的分组和掩码。

## 原理

每一个碰撞对象都会持有一个碰撞分组，对象之间要形成碰撞必须满足自身设置的碰撞掩码与目标对象的碰撞分组进行“&“操作后大于 0，只有一方满足而另一方不满足的情况下，则不会进行碰撞检测。启用对象间碰撞检测的计算方式如下：

```ts
(GroupA & MaskB) && (GroupB & MaskA)
```

一个启用对象间碰撞检测的简单案例如下：

假设场景中有两个物理元素 **A** 和 **B**。其中：

- **A** 的分组值为 `1`，二进制值为 `1`；掩码值为 `3`，二进制为 `11`，代表允许和分组值为 `1` 或 `2` 的对象发生碰撞。

- **B** 的分组值为 `2`，二进制为 `10`；掩码值为 `2`，二进制为 `10`，代表只允许和分组值为 `2` 的对象发生碰撞。

**A** 和 **B** 经过计算 `(1 & 2) && (2 & 3)` 为假，所以这里 **A** 不会和 **B** 进行检测。

> **注意**：表达式依赖位运算，`JavaScript` 中位运算的操作数为 `32` 位，且最后一位是符号位，为避免超出运算范围，建议组的范围为 `[0, 31)`。

## 分组

通常，可以采用左移操作符（<<）对分组或者掩码进行设置。

### 设置分组值

```ts
  // 1 << 0 = 1，1 << 1 = 2，得出当前的分组值为 3
  const group = (1 << 0) + (1 << 1);
  Collider.setGroup(group);
```

### 获取分组值

```ts
  Collider.getGroup();
```

### 增加/减少分组值

```ts
  // 假设当前分组值为 3，二进制值为 11
  const group = 1 << 2;
  Collider.addGroup(group);
  // 添加了分组之后，现在的值为 7，二进制值为 111
  Collider.removeGroup(group);
  // 这样分组值又恢复成 3
```

> **注意**：
> - 推荐分组固定为一个位，并通过掩码来控制可检测的分组。
> - 上述方法接收参数均为十进制数字，为方便理解，此处用二进制解释，开发者熟悉后也可直接传入十进制数字进行分组操作。
> - 此处如果是自行计算，而不是通过 addGroup 或者 removeGroup 的方式增加/减少分组值，需要注意操作符的优先级。例如：3 + 1 << 2 和 3 + (1 << 2) 所计算的值是不相等的，操作符 + 的优先级大于 <<。

## 掩码

### 设置掩码值

```ts
  const mask = (1 << 0) + (1 << 1);
  Collider.setMask(mask);
```

### 获取掩码值

```ts
  Collider.getMask();
```

### 增加/减少掩码值

```ts
  // 假设当前掩码值为 3，二进制值为 11
  const mask = 1 << 2;
  Collider.addMask(mask);
  // 添加了掩码 mask 之后，现在的值为 7，二进制值为 111
  Collider.removeMask(mask);
  // 这样分组值又恢复成 3
```

> **注意**：
> - 加减符号的优先级高于位移符号。
> - 灵活使用分组和掩码可以减少额外检测的消耗。

## 使用

### 定义分组

方式一：定义在一个 **object** 中

```ts
export const PHY_GROUP = {
    Group0: 1 << 0,
    Group1: 1 << 1
};
```

方式二：定义在一个 **enum** 中

```ts
enum PHY_GROUP {
    Group0 = 1 << 0,
    Group1 = 1 << 1
};
```

为了能够在面板上设置分组，需要通过 **cc** 模块导出的 **Enum** 函数，将定义好的分组注册到编辑器中 `Enum(PHY_GROUP)`。

> **注意**：由于历史原因， **Enum** 函数对 **-1** 有特殊处理，如果不熟悉，请勿定义值为 **-1** 的属性。

### 使用掩码

掩码可以根据分组进行定义，例如以下示例

- 定义一个只检测 **Group1** 的掩码 `const maskForGroup1 = PHY_GROUP.Group1;`
- 定义一个可检测 **Group0** 和 **Group1** 的掩码 `const maskForGroup01 = PHY_GROUP.Group0 | PHY_GROUP.Group1;`
- 定义一个所有组都不检测的掩码 `const maskForNone = 0;`
- 定义一个所有组都检测的掩码 `const maskForAll = 0xffffffff;`

### 查看二进制

通过 `(value >>> 0).toString(2)`，可以看到二进制的字符串表示。

![查看二进制](img/mask-all.jpg)

## 碰撞矩阵

碰撞矩阵是对分组掩码配置的进一步封装，它提供了一种更加统一的管理方式，用于初始化刚体的分组和掩码，同时也无需书写任何代码即可完成初始化配置。

具体请参考 [碰撞矩阵](physics-configs.md#%E7%A2%B0%E6%92%9E%E7%9F%A9%E9%98%B5)。
